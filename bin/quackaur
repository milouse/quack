#!/usr/bin/env ruby
# frozen_string_literal: true

require 'optparse'
require_relative '../lib/trsl'
require_relative '../lib/quack_aur/version'

Trsl.init

params = { color: :auto, jail: :docker }
parser = OptionParser.new
parser.banner = <<~BANNER
  A Qualitative and Usable Aur paCKage helper

  Usage: quackaur -h
         quackaur -A [--devel] package [package ...]
         quackaur -A (-l, -u) [--devel]
         quackaur -A (-s, -i) package [package ...]
         quackaur -C (-l, -c)

  Commands
BANNER

parser.define_head(
  '-C', '--clean', Trsl['cli.clean_help'], Trsl['cli.clean_help_2']
) do
  raise Trsl['cli.ca_mutually_exclusive'] if params[:aur]

  params[:operation] = :clean
end
parser.define_head(
  '-A', '--aur', Trsl['cli.aur_help'], Trsl['cli.aur_help_2']
) do
  raise Trsl['cli.ac_mutually_exclusive'] if params[:clean]

  params[:operation] = :aur
end

parser.separator ''
parser.separator Trsl['cli.shared_options_title']
parser.define('-v', '--version', Trsl['cli.version_help']) do
  puts "quackaur - v#{QuackAur::VERSION}"
  exit
end
parser.define(
  '--color [WHEN]', %i[always never auto],
  Trsl['cli.color_help'], Trsl['cli.color_choices']
) { params[:color] = _1 }
parser.define(
  '-l', '--list', Trsl['cli.list_help'], Trsl['cli.list_help_2']
) { params[:action] = :list }

parser.separator ''
parser.separator Trsl['cli.aur_actions_title']
parser.define('-i', '--info', Trsl['cli.info_help']) do
  params[:action] = :info
end
parser.define('-s', '--search', Trsl['cli.search_help']) do
  params[:action] = :search
end
parser.define('-u', '--upgrade', Trsl['cli.upgrade_help']) do
  params[:action] = :upgrade
end

parser.separator ''
parser.separator Trsl['cli.aur_options_title']
parser.define('--devel', Trsl['cli.devel_help']) do
  params[:with_devel] = true
end
parser.define('--force', Trsl['cli.force_help']) do
  params[:force] = true
end
parser.define(
  '-j', '--jail [JAIL]', %i[docker chroot],
  Trsl['cli.jail_help'],
  Trsl['cli.jail_choices']
) { params[:jail] = _1 }
parser.define('--no-jail', Trsl['cli.no_jail_help']) do
  params[:jail] = :none
end
parser.define('-n', '--dry-run', Trsl['cli.dry_run_help']) do
  params[:dry_run] = true
end

parser.separator ''
parser.separator Trsl['cli.clean_actions_title']
parser.define('-c', '--do-clean', Trsl['cli.do_clean_help']) do
  params[:action] = :purge
end

parser.separator ''
parser.separator Trsl['cli.clean_options_title']
parser.define('-d', '--deep-search', Trsl['cli.dsearch_help']) do
  params[:deep_search] = true
end

# rubocop:disable Layout/HeredocIndentation
parser.separator <<-FOOTER
     _         _
  __(.)>    __(.)<  Quack Quack
~~\\___)~~~~~\\___)~~~~~~~~~~~~~~~~~~
FOOTER
# rubocop:enable Layout/HeredocIndentation

begin
  argv = parser.parse!

  raise Trsl['cli.ac_required'] unless params.has_key?(:operation)
rescue RuntimeError => e
  warn e
  exit 2
end

if params[:operation] == :aur
  require_relative '../lib/quack_aur/aur'
  aur = QuackAur::Aur.new(params)
  action = params[:action] || :install
  if %i[list upgrade].include?(action)
    aur.send action
  else
    aur.send action, argv
  end

elsif params[:operation] == :clean
  require_relative '../lib/quack_aur/cleaner'
  cleaner = QuackAur::Cleaner.new(params)
  cleaner.send(params[:action] || :list)
end
